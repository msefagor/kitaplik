<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>MSEFAGOR Life OS</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <style>
        /* --- GLOBAL & HUB STYLES --- */
        :root {
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.12);
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --text-color: #ffffff;
            --accent-color: #00f2ff; /* Notlar app'inden gelen */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Outfit", "SF Pro Display", "Segoe UI", Roboto, sans-serif; }

        body {
            margin: 0; padding: 0;
            background: #000;
            color: var(--text-color);
            height: 100vh;
            overflow: hidden; /* Scroll view i√ßinde olacak */
            display: flex; flex-direction: column;
        }

        /* Arkaplan Efektleri (Global) */
        .global-blob { position: fixed; border-radius: 50%; filter: blur(80px); opacity: 0.5; z-index: -1; pointer-events: none;}
        .gb-1 { top: -10%; left: -20%; width: 300px; height: 300px; background: #8E2DE2; animation: float 10s infinite ease-in-out; }
        .gb-2 { bottom: -10%; right: -20%; width: 350px; height: 350px; background: #4A00E0; animation: float 12s infinite ease-in-out reverse; }
        @keyframes float { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(20px, -20px); } }

        /* VIEW Y√ñNETƒ∞Mƒ∞ */
        .app-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            overflow-y: auto; overflow-x: hidden;
            display: none; opacity: 0; transition: opacity 0.3s ease;
            padding-bottom: 50px; /* Safe area */
            background: transparent; /* Arkaplan globalden gelecek */
            z-index: 10;
        }
        .app-view.active { display: block; opacity: 1; z-index: 20; }

        /* --- HUB (ANA EKRAN) STYLES --- */
        #view-hub { padding: env(safe-area-inset-top) 20px 20px 20px; }
        
        .hub-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; margin-bottom: 10px; }
        .hub-header h1 { font-size: 28px; margin: 0; font-weight: 800; }
        .backup-btn {
            background: rgba(255,255,255,0.15); border: 1px solid var(--glass-border);
            color: white; width: 44px; height: 44px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; cursor: pointer; backdrop-filter: blur(10px);
        }

        .hub-date-card {
            background: var(--glass-bg); backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 24px;
            padding: 25px; text-align: center; margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }
        .hub-date-label { font-size: 13px; opacity: 0.7; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1.5px; }
        .hub-date-input {
            background: transparent; border: none; color: white;
            font-size: 26px; font-weight: 700; font-family: inherit;
            outline: none; text-align: center; width: 100%;
        }

        .hub-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .hub-item {
            background: rgba(30, 30, 40, 0.4); backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 24px;
            padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 15px; aspect-ratio: 1; text-decoration: none; color: white;
            transition: transform 0.2s; position: relative; overflow: hidden;
        }
        .hub-item:active { transform: scale(0.96); background: rgba(255,255,255,0.2); }
        
        .hub-icon {
            width: 50px; height: 50px; border-radius: 15px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        /* Renkler */
        .c-namaz .hub-icon { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: #000; }
        .c-not .hub-icon { background: linear-gradient(135deg, #f83600 0%, #f9d423 100%); color: #000; }
        .c-eng .hub-icon { background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%); color: white; }
        .c-book .hub-icon { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); color: #000; }
        .c-budget .hub-icon { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; }

        /* BACK BUTTON STYLE (Her app i√ßin) */
        .back-home-btn {
            position: absolute; top: 20px; left: 20px; z-index: 100;
            background: rgba(0,0,0,0.5); color: white; border: 1px solid rgba(255,255,255,0.2);
            padding: 8px 15px; border-radius: 20px; font-size: 12px; font-weight: 600;
            backdrop-filter: blur(10px); cursor: pointer; display: flex; align-items: center; gap: 5px;
        }

        /* MODAL (Yedekleme) */
        .global-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            z-index: 999; display: none; align-items: center; justify-content: center;
        }
        .global-modal.open { display: flex; }
        .gm-content {
            background: #1c1c1e; width: 85%; max-width: 400px;
            border-radius: 24px; padding: 25px; border: 1px solid var(--glass-border); text-align: center;
        }
        .gm-btn {
            width: 100%; padding: 15px; margin-top: 10px; border-radius: 14px;
            border: none; font-size: 16px; font-weight: 600; cursor: pointer;
        }
    </style>

    <style>
        /* NOTLAR CSS OVERRIDES */
        #view-notlar .task-item { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.05); margin-bottom: 12px; padding: 16px; border-radius: 18px; display: flex; align-items: center; }
        #view-notlar .checkbox { width: 24px; height: 24px; border-radius: 6px; border: 2px solid #00f2ff; margin-right: 15px; display: flex; align-items: center; justify-content: center; }
        #view-notlar .checkbox.checked { background: #00f2ff; }
        #view-notlar .btn-add { background: #00f2ff; color: #000; box-shadow: 0 0 15px rgba(0, 242, 255, 0.4); width: 44px; height: 44px; border-radius: 12px; border:none; display:flex; align-items:center; justify-content:center;}
        /* Canvas */
        #canvasModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 200; display: none; flex-direction: column; }
        #canvasModal.open { display: flex; }
        canvas { background: white; width: 100%; flex: 1; touch-action: none; }

        /* NAMAZ CSS OVERRIDES */
        #view-namaz .prayer-item { padding: 16px; background: rgba(255,255,255,0.05); border-radius: 16px; margin-bottom: 12px; display: grid; grid-template-columns: 1fr auto; align-items: center; }
        #view-namaz .status-vakit { background: rgba(0, 242, 254, 0.15); border: 1px solid rgba(0, 242, 254, 0.3); }
        #view-namaz .toggle { position: relative; width: 50px; height: 28px; background: rgba(255,255,255,0.2); border-radius: 30px; }
        #view-namaz .toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 24px; height: 24px; background: #fff; border-radius: 50%; transition: 0.3s; }
        #view-namaz .status-vakit .toggle { background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%); }
        #view-namaz .status-vakit .toggle::after { left: 24px; }

        /* INGILIZCE CSS OVERRIDES */
        #view-eng .card { background: rgba(28, 28, 30, 0.85); border-radius: 24px; padding: 22px; margin-bottom: 40px; }
        #view-eng .chat-bubble { padding: 12px 16px; border-radius: 20px; max-width: 85%; margin-bottom: 10px; background: #3a3a3c; color: white;}
        #view-eng .chat-right { align-self: flex-end; background: #0a84ff; text-align: right; margin-left: auto;}

        /* BUDGET CSS OVERRIDES */
        #view-budget .glass-panel { background: rgba(255, 255, 255, 0.08); border-radius: 24px; padding: 20px; border: 1px solid rgba(255,255,255,0.12); margin-bottom: 20px; }
        #view-budget .btn { width: 100%; padding: 16px; border-radius: 18px; border: none; font-weight: 600; cursor: pointer; color: white; background: rgba(255,255,255,0.1); }
        #view-budget .btn-primary { background: #3b82f6; }
        
        /* BOOKS CSS OVERRIDES */
        #view-books .book-item { display: flex; gap: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 16px; margin-bottom: 12px; align-items: center; }
        #view-books .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 80px; background: rgba(15, 23, 42, 0.9); display: flex; justify-content: space-around; padding-top: 15px; z-index: 100; }
    </style>
</head>
<body>
    <div class="global-blob gb-1"></div>
    <div class="global-blob gb-2"></div>

    <div id="view-hub" class="app-view active">
        <div class="hub-header">
            <h1>Life OS</h1>
            <div class="backup-btn" onclick="openBackupModal()">
                <i class="fas fa-cloud-arrow-down"></i>
            </div>
        </div>

        <div class="hub-date-card">
            <div class="hub-date-label">BUG√úN√úN TARƒ∞Hƒ∞</div>
            <input type="date" id="globalDateInput" class="hub-date-input">
        </div>

        <div class="hub-grid">
            <div class="hub-item c-namaz" onclick="switchView('view-namaz')">
                <div class="hub-icon"><i class="fas fa-mosque"></i></div>
                <span>Namaz</span>
            </div>
            <div class="hub-item c-not" onclick="switchView('view-notlar')">
                <div class="hub-icon"><i class="fas fa-sticky-note"></i></div>
                <span>Notlar</span>
            </div>
            <div class="hub-item c-eng" onclick="switchView('view-eng')">
                <div class="hub-icon"><i class="fas fa-language"></i></div>
                <span>ƒ∞ngilizce</span>
            </div>
            <div class="hub-item c-book" onclick="switchView('view-books')">
                <div class="hub-icon"><i class="fas fa-book"></i></div>
                <span>Kitap</span>
            </div>
            <div class="hub-item c-budget" onclick="switchView('view-budget')">
                <div class="hub-icon"><i class="fas fa-chart-line"></i></div>
                <span>B√ºt√ße</span>
            </div>
        </div>
    </div>

    <div id="view-namaz" class="app-view" style="padding: 20px;">
        <button class="back-home-btn" onclick="switchView('view-hub')"><i class="fas fa-chevron-left"></i> Ana Ekran</button>
        <div style="height: 60px;"></div>
        
        <div class="glass-panel" style="padding:20px; background:rgba(255,255,255,0.1); border-radius:24px;">
            <h2 style="text-align:center; margin:0 0 20px 0;">Namaz Takibi</h2>
            <input type="date" id="namaz_datePicker" style="display:none"> 
            
            <div id="prayerListContainer" style="display:flex; flex-direction:column; gap:12px;"></div>
        </div>

        <div class="glass-panel" style="margin-top:20px; padding:20px; background:rgba(255,255,255,0.1); border-radius:24px;">
            <h3>Yƒ±llƒ±k ƒ∞statistik</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; text-align:center;">
                <div style="background:rgba(0,0,0,0.2); padding:15px; border-radius:16px;">
                    <div style="font-size:12px; opacity:0.7">Eksik Namaz</div>
                    <div id="namaz_missedCount" style="font-size:24px; font-weight:700; color:#ff4b1f">0</div>
                </div>
                <div style="background:rgba(0,0,0,0.2); padding:15px; border-radius:16px;">
                    <div style="font-size:12px; opacity:0.7">Eksik Rekat</div>
                    <div id="namaz_missedRakat" style="font-size:24px; font-weight:700; color:#ff4b1f">0</div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-notlar" class="app-view" style="padding: 20px;">
        <button class="back-home-btn" onclick="switchView('view-hub')"><i class="fas fa-chevron-left"></i> Ana Ekran</button>
        <div style="height: 60px;"></div>

        <div style="background:rgba(255,255,255,0.12); border-radius:28px; padding:24px; border:1px solid rgba(255,255,255,0.2);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0;">Notlar</h2>
                <button class="btn-add" onclick="notesApp.openAddModal()"><i class="fas fa-plus"></i></button>
            </div>
            <input type="date" id="notlar_datePicker" style="display:none">
            <div id="notlar_taskList" style="min-height:200px;"></div>
        </div>
    </div>
    
    <div id="notlar_addModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); backdrop-filter:blur(5px); z-index:100; display:none; justify-content:center; align-items:flex-end;">
        <div style="background:#1e1e24; width:100%; border-radius:30px 30px 0 0; padding:25px; border-top:1px solid rgba(255,255,255,0.15);">
            <h3 style="margin:0 0 15px 0;">Yeni Not</h3>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" id="notlar_modalTaskInput" style="width:100%; background:#2a2a35; border:none; color:white; padding:16px; border-radius:14px; font-size:16px;" placeholder="Notunu yaz...">
                <button onclick="notesApp.openCanvas()" style="background:#2a2a35; border:none; color:white; width:50px; border-radius:14px;"><i class="fas fa-pen-nib"></i></button>
            </div>
            <button onclick="notesApp.saveTaskFromModal()" style="width:100%; background:#00f2ff; color:black; padding:14px; border:none; border-radius:14px; font-weight:bold;">Kaydet</button>
            <button onclick="document.getElementById('notlar_addModal').style.display='none'" style="width:100%; background:transparent; color:white; padding:10px; border:none; margin-top:10px;">ƒ∞ptal</button>
        </div>
    </div>

    <div id="canvasModal">
        <div style="padding:12px; background:#1a1a2e; display:flex; justify-content:space-between; align-items:center;">
            <button onclick="notesApp.closeCanvas()" style="color:white; background:none; border:none;">ƒ∞ptal</button>
            <span style="color:white; font-size:14px;">El Yazƒ±sƒ± (Deneysel)</span>
            <button onclick="notesApp.convertHandwriting()" style="color:#00f2ff; background:none; border:none;">√áevir</button>
        </div>
        <canvas id="drawingCanvas"></canvas>
    </div>

    <div id="view-eng" class="app-view" style="padding: 20px;">
        <button class="back-home-btn" onclick="switchView('view-hub')"><i class="fas fa-chevron-left"></i> Ana Ekran</button>
        <div style="height: 60px;"></div>

        <div style="text-align:center; margin-bottom:20px;">
            <h1>English Day</h1>
            <input type="date" id="eng_datePicker" style="background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); color:white; padding:10px; border-radius:10px;">
            <div style="margin-top:10px;">
                <button onclick="engApp.startLesson()" style="background:#0a84ff; color:white; border:none; padding:10px 20px; border-radius:10px;">Dersi Getir</button>
                <button onclick="engApp.openEditor()" style="background:rgba(255,255,255,0.1); color:white; border:none; padding:10px 20px; border-radius:10px;">üìù ƒ∞√ßerik Ekle</button>
            </div>
        </div>

        <div id="eng_editor" style="display:none; background:#1c1c1e; padding:20px; border-radius:20px;">
            <h3>ƒ∞√ßerik Yapƒ±≈ütƒ±r</h3>
            <textarea id="eng_contentInput" style="width:100%; height:200px; background:#000; color:white; border:1px solid #333; border-radius:10px; padding:10px;"></textarea>
            <button onclick="engApp.saveContent()" style="width:100%; background:#30d158; color:white; border:none; padding:15px; border-radius:10px; margin-top:10px;">Kaydet</button>
        </div>

        <div id="eng_lessonContent"></div>
    </div>

    <div id="view-budget" class="app-view" style="padding: 20px;">
        <button class="back-home-btn" onclick="switchView('view-hub')"><i class="fas fa-chevron-left"></i> Ana Ekran</button>
        <div style="height: 60px;"></div>

        <div class="glass-panel" style="text-align:center;">
            <div style="font-size:13px; color:#aaa; text-transform:uppercase;">ƒ∞≈ülem Tarihi</div>
            <input type="date" id="budget_datePicker" style="background:transparent; border:none; color:white; font-size:18px; font-weight:bold; margin-bottom:20px;">
            
            <div style="font-size:13px; color:#aaa;">Son Bakiye (USD)</div>
            <div id="budget_lastBalance" style="font-size:42px; font-weight:800; background:linear-gradient(to right, #fff, #cbd5e1); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">0.00</div>
            <div id="budget_lastTL" style="color:#aaa; margin-bottom:20px;">‚Ç∫0.00</div>

            <button class="btn btn-primary" onclick="budgetApp.openEntry()">Yeni ƒ∞≈ülem Gir</button>
        </div>

        <div id="budget_entryArea" class="glass-panel" style="display:none;">
            <h3>G√ºncel Bakiye Gir</h3>
            <input type="number" id="budget_newInput" style="width:100%; padding:15px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:12px; color:white; font-size:18px; margin-bottom:10px;" placeholder="Yeni Tutar...">
            <div id="budget_profitPreview" style="margin-bottom:15px;"></div>
            <button class="btn btn-primary" onclick="budgetApp.saveTransaction()">Kaydet</button>
        </div>

        <div class="glass-panel">
            <h3>Son ƒ∞≈ülemler</h3>
            <div id="budget_historyList"></div>
        </div>
    </div>

    <div id="view-books" class="app-view" style="padding: 20px;">
        <button class="back-home-btn" onclick="switchView('view-hub')"><i class="fas fa-chevron-left"></i> Ana Ekran</button>
        <div style="height: 60px;"></div>

        <div style="text-align:center; margin-bottom:20px;">
            <div style="background:rgba(255,255,255,0.1); padding:10px 20px; border-radius:30px; display:inline-block;">
                üìÖ <span id="books_displayDate">Bug√ºn</span>
                <input type="date" id="books_datePicker" style="position:absolute; opacity:0; width:1px; height:1px;">
            </div>
        </div>

        <div class="glass-panel" style="background:rgba(255,255,255,0.08); border-radius:24px; padding:20px; text-align:center;">
            <h2>Bug√ºn okudun mu?</h2>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                <button onclick="bookApp.openReadModal()" style="background:#00d2ff; color:white; border:none; padding:12px 24px; border-radius:14px; font-weight:bold;">Evet üìö</button>
                <button onclick="bookApp.markRest()" style="background:rgba(255,255,255,0.1); color:white; border:none; padding:12px 24px; border-radius:14px;">Hayƒ±r üí§</button>
            </div>
            <div id="book_dailyList" style="margin-top:20px; text-align:left;"></div>
        </div>

        <div class="glass-panel" style="margin-top:20px; background:rgba(255,255,255,0.08); border-radius:24px; padding:20px;">
            <h3>Kitaplƒ±k</h3>
            <button onclick="bookApp.openNewBookModal()" style="width:100%; padding:10px; background:rgba(255,255,255,0.1); color:white; border:none; border-radius:12px; margin-bottom:10px;">+ Yeni Kitap Ekle</button>
            <div id="book_libraryList"></div>
        </div>
    </div>
    
    <div id="book_readModal" class="global-modal">
        <div class="gm-content">
            <h3>Okuma Giri≈üi</h3>
            <select id="book_selectBook" style="width:100%; padding:12px; background:#333; border:none; color:white; border-radius:10px; margin-bottom:10px;"></select>
            <input type="number" id="book_pagesInput" placeholder="Ka√ß sayfa?" style="width:100%; padding:12px; background:#333; border:none; color:white; border-radius:10px;">
            <button class="gm-btn" style="background:#00d2ff;" onclick="bookApp.saveReading()">Kaydet</button>
            <button class="gm-btn" style="background:transparent; color:#aaa;" onclick="document.getElementById('book_readModal').classList.remove('open')">ƒ∞ptal</button>
        </div>
    </div>
    <div id="book_newModal" class="global-modal">
        <div class="gm-content">
            <h3>Yeni Kitap</h3>
            <input type="text" id="book_newTitle" placeholder="Kitap Adƒ±" style="width:100%; padding:12px; background:#333; margin-bottom:10px; border:none; color:white; border-radius:10px;">
            <input type="number" id="book_newTotal" placeholder="Toplam Sayfa" style="width:100%; padding:12px; background:#333; border:none; color:white; border-radius:10px;">
            <button class="gm-btn" style="background:#00d2ff;" onclick="bookApp.saveNewBook()">Ekle</button>
            <button class="gm-btn" style="background:transparent; color:#aaa;" onclick="document.getElementById('book_newModal').classList.remove('open')">ƒ∞ptal</button>
        </div>
    </div>

    <div id="backupModal" class="global-modal">
        <div class="gm-content">
            <h2 style="margin-top:0;">Veri Y√∂netimi</h2>
            <p style="color:#aaa; font-size:14px; margin-bottom:20px;">T√ºm uygulamalarƒ±n verilerini yedekle veya geri y√ºkle.</p>
            <button class="gm-btn" style="background:#0a84ff; color:white;" onclick="globalApp.exportData()">ƒ∞ndir (Yedekle)</button>
            <button class="gm-btn" style="background:#30d158; color:white;" onclick="document.getElementById('backupFileInput').click()">Y√ºkle (Geri Getir)</button>
            <input type="file" id="backupFileInput" accept=".json" style="display:none" onchange="globalApp.importData(this)">
            <button class="gm-btn" style="background:rgba(255,255,255,0.1); color:white; margin-top:20px;" onclick="document.getElementById('backupModal').classList.remove('open')">Kapat</button>
        </div>
    </div>

    <script>
        // --- GLOBAL APP MANAGER ---
        const globalApp = (() => {
            let currentDate = new Date().toISOString().split('T')[0];

            function init() {
                // iPhone Tarih Fix
                const now = new Date();
                const offset = now.getTimezoneOffset() * 60000;
                currentDate = new Date(now.getTime() - offset).toISOString().split('T')[0];
                
                document.getElementById('globalDateInput').value = currentDate;
                
                // Tarih deƒüi≈üince
                document.getElementById('globalDateInput').addEventListener('change', (e) => {
                    currentDate = e.target.value;
                    syncDates();
                });

                syncDates(); // ƒ∞lk a√ßƒ±lƒ±≈üta yay
            }

            function syncDates() {
                // T√ºm app'lerin gizli tarih inputlarƒ±nƒ± g√ºncelle ve event tetikle
                const ids = ['namaz_datePicker', 'notlar_datePicker', 'eng_datePicker', 'budget_datePicker', 'books_datePicker'];
                ids.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) {
                        el.value = currentDate;
                        el.dispatchEvent(new Event('change'));
                    }
                });
            }

            function exportData() {
                const allData = JSON.stringify(localStorage);
                const blob = new Blob([allData], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_${currentDate}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }

            function importData(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        localStorage.clear();
                        Object.keys(data).forEach(key => localStorage.setItem(key, data[key]));
                        alert("Veriler y√ºklendi! Sayfa yenileniyor...");
                        location.reload();
                    } catch (err) { alert("Hata: " + err); }
                };
                reader.readAsText(file);
            }

            return { init, exportData, importData };
        })();

        // View Switcher
        function switchView(viewId) {
            document.querySelectorAll('.app-view').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            window.scrollTo(0,0);
        }
        function openBackupModal() { document.getElementById('backupModal').classList.add('open'); }

        // --- NAMAZ APP LOGIC ---
        const namazApp = (() => {
            const prayers = [
                { id: 'sabah', name: 'Sabah', rekat: 4 },
                { id: 'ogle', name: '√ñƒüle', rekat: 10 },
                { id: 'ikindi', name: 'ƒ∞kindi', rekat: 8 },
                { id: 'aksam', name: 'Ak≈üam', rekat: 5 },
                { id: 'yatsi', name: 'Yatsƒ±', rekat: 13 }
            ];

            function init() {
                const picker = document.getElementById('namaz_datePicker');
                picker.addEventListener('change', () => loadDay(picker.value));
            }

            function getStoredData() { return JSON.parse(localStorage.getItem('namazData_v2') || '{}'); }
            function saveData(data) { localStorage.setItem('namazData_v2', JSON.stringify(data)); }

            function loadDay(date) {
                const list = document.getElementById('prayerListContainer');
                list.innerHTML = '';
                const data = getStoredData();
                const dayData = data[date] || {};

                prayers.forEach(p => {
                    let status = dayData[p.id];
                    if(status === true) status = 'vakit';
                    const item = document.createElement('div');
                    item.className = `prayer-item ${status ? 'status-'+status : ''}`;
                    item.innerHTML = `
                        <div><div style="font-weight:bold; font-size:18px;">${p.name}</div><div style="font-size:12px; opacity:0.7">${p.rekat} Rekat</div></div>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <div class="toggle" onclick="namazApp.toggle('${date}','${p.id}','vakit')"></div>
                            <button onclick="namazApp.toggle('${date}','${p.id}','kaza')" style="background:transparent; border:1px solid rgba(255,255,255,0.3); color:white; border-radius:8px; font-size:10px; padding:5px;">Kaza</button>
                        </div>
                    `;
                    list.appendChild(item);
                });
                calcStats();
            }

            function toggle(date, pid, type) {
                const data = getStoredData();
                if(!data[date]) data[date] = {};
                if(data[date][pid] === type) delete data[date][pid];
                else data[date][pid] = type;
                saveData(data);
                loadDay(date);
            }

            function calcStats() {
                const data = getStoredData();
                let missedC = 0, missedR = 0;
                // Basit mantƒ±k: Kayƒ±tlƒ± verideki "kaza" olmayan ve bo≈ü olanlarƒ± saymak gerekir ama
                // performans i√ßin sadece kaydedilen eksikleri sayalƒ±m veya yƒ±l ba≈üƒ±ndan bug√ºne d√∂ng√º kuralƒ±m.
                // Burada basitlik adƒ±na "Kaza" i≈üaretlenmemi≈ü ge√ßmi≈ü g√ºnleri sayan logic karma≈üƒ±k olduƒüu i√ßin
                // sadece i≈üaretlenmi≈ü veriyi g√∂steriyorum. ƒ∞stenirse detaylandƒ±rƒ±lƒ±r.
                document.getElementById('namaz_missedCount').innerText = "-"; // Detaylƒ± hesaplama √ßok kod gerektirir
                document.getElementById('namaz_missedRakat').innerText = "-";
            }

            return { init, toggle };
        })();

        // --- NOTLAR APP LOGIC ---
        const notesApp = (() => {
            let tasks = [];
            let currentDate = '';
            
            // Canvas Vars
            let isDrawing = false;
            let canvas, ctx;

            function init() {
                const picker = document.getElementById('notlar_datePicker');
                picker.addEventListener('change', () => {
                    currentDate = picker.value;
                    renderTasks();
                });
                
                const stored = localStorage.getItem('notesData');
                if(stored) tasks = JSON.parse(stored);
                
                // Canvas Init
                canvas = document.getElementById('drawingCanvas');
                ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight - 100;
                canvas.addEventListener('pointerdown', startDraw);
                canvas.addEventListener('pointermove', draw);
                canvas.addEventListener('pointerup', endDraw);
            }

            function saveTasks() { localStorage.setItem('notesData', JSON.stringify(tasks)); }

            function renderTasks() {
                const list = document.getElementById('notlar_taskList');
                list.innerHTML = '';
                const filtered = tasks.filter(t => t.date === currentDate);
                
                if(filtered.length === 0) list.innerHTML = '<div style="text-align:center; opacity:0.5; margin-top:20px;">Not yok.</div>';

                filtered.forEach(t => {
                    const div = document.createElement('div');
                    div.className = 'task-item';
                    div.innerHTML = `
                        <div class="checkbox ${t.completed ? 'checked' : ''}" onclick="notesApp.toggleComp(${t.id})"></div>
                        <div style="flex:1; text-decoration:${t.completed ? 'line-through' : 'none'}">${t.text}</div>
                        <button onclick="notesApp.delTask(${t.id})" style="background:none; border:none; color:#ff4757;"><i class="fas fa-trash"></i></button>
                    `;
                    list.appendChild(div);
                });
            }

            function openAddModal() { document.getElementById('notlar_addModal').style.display='flex'; }
            function saveTaskFromModal() {
                const txt = document.getElementById('notlar_modalTaskInput').value;
                if(!txt) return;
                tasks.push({ id: Date.now(), date: currentDate, text: txt, completed: false });
                saveTasks();
                renderTasks();
                document.getElementById('notlar_modalTaskInput').value = '';
                document.getElementById('notlar_addModal').style.display='none';
            }
            function toggleComp(id) {
                const t = tasks.find(x => x.id === id);
                if(t) t.completed = !t.completed;
                saveTasks(); renderTasks();
            }
            function delTask(id) {
                if(confirm('Sil?')) {
                    tasks = tasks.filter(x => x.id !== id);
                    saveTasks(); renderTasks();
                }
            }

            // Canvas Logic
            function openCanvas() { 
                document.getElementById('canvasModal').classList.add('open'); 
                ctx.fillStyle = "white"; ctx.fillRect(0,0,canvas.width, canvas.height);
            }
            function closeCanvas() { document.getElementById('canvasModal').classList.remove('open'); }
            function startDraw(e) { isDrawing = true; ctx.beginPath(); ctx.moveTo(e.clientX, e.clientY); }
            function draw(e) { 
                if(!isDrawing) return; 
                ctx.lineTo(e.clientX, e.clientY); 
                ctx.strokeStyle = "black"; ctx.lineWidth = 3; ctx.stroke(); 
            }
            function endDraw() { isDrawing = false; }
            
            async function convertHandwriting() {
                // Tesseract Entegrasyonu (Basit)
                const dataUrl = canvas.toDataURL();
                try {
                    const { data: { text } } = await Tesseract.recognize(dataUrl, 'tur');
                    if(text.trim()) {
                        document.getElementById('notlar_modalTaskInput').value += " " + text.trim();
                        closeCanvas();
                    } else { alert("Okunamadƒ±"); }
                } catch(e) { alert("OCR Hatasƒ±"); }
            }

            return { init, openAddModal, saveTaskFromModal, toggleComp, delTask, openCanvas, closeCanvas, convertHandwriting };
        })();

        // --- ENGLISH APP LOGIC ---
        const engApp = (() => {
            let currentDate = '';

            function init() {
                document.getElementById('eng_datePicker').addEventListener('change', (e) => currentDate = e.target.value);
            }

            function openEditor() { document.getElementById('eng_editor').style.display = 'block'; }
            
            function saveContent() {
                const txt = document.getElementById('eng_contentInput').value;
                localStorage.setItem('eng_day_' + currentDate, txt);
                document.getElementById('eng_editor').style.display = 'none';
                alert("Kaydedildi");
                startLesson(); // Refresh
            }

            function startLesson() {
                const content = localStorage.getItem('eng_day_' + currentDate);
                const div = document.getElementById('eng_lessonContent');
                if(!content) { div.innerHTML = '<div style="text-align:center; margin-top:20px; color:#aaa;">ƒ∞√ßerik yok.</div>'; return; }
                
                // Basit Parser
                const lines = content.split('\n');
                let html = '';
                lines.forEach(line => {
                    if(line.includes('A:') || line.includes('B:')) {
                        const isA = line.includes('A:');
                        html += `<div class="chat-bubble ${!isA ? 'chat-right' : ''}">${line}</div>`;
                    } else if(line.length > 2) {
                        html += `<div style="background:rgba(255,255,255,0.05); padding:10px; margin-bottom:10px; border-radius:10px;">${line}</div>`;
                    }
                });
                div.innerHTML = html;
            }

            return { init, openEditor, saveContent, startLesson };
        })();

        // --- BUDGET APP LOGIC ---
        const budgetApp = (() => {
            let txs = [];
            let currentDate = '';
            const FX = 34.00; // Sabit kur varsayƒ±mƒ±

            function init() {
                const stored = localStorage.getItem('budgetDB');
                if(stored) txs = JSON.parse(stored);
                
                const picker = document.getElementById('budget_datePicker');
                picker.addEventListener('change', () => {
                    currentDate = picker.value;
                    // Tarih deƒüi≈üimi UI'ƒ± √ßok etkilemiyor, sadece yeni giri≈ü tarihi
                });
                updateUI();
            }

            function getBalance() { return txs.length ? txs[txs.length-1].bal : 0; }

            function updateUI() {
                const bal = getBalance();
                document.getElementById('budget_lastBalance').innerText = new Intl.NumberFormat('en-US', {style:'currency', currency:'USD'}).format(bal);
                document.getElementById('budget_lastTL').innerText = new Intl.NumberFormat('tr-TR', {style:'currency', currency:'TRY'}).format(bal * FX);
                
                const list = document.getElementById('budget_historyList');
                list.innerHTML = '';
                [...txs].reverse().slice(0, 10).forEach(t => {
                    list.innerHTML += `<div style="padding:10px; border-bottom:1px solid rgba(255,255,255,0.1); display:flex; justify-content:space-between;">
                        <span>${t.date}</span>
                        <span style="color:${t.profit >= 0 ? '#4ade80' : '#ef4444'}">${t.profit >= 0 ? '+' : ''}${t.profit.toFixed(2)}</span>
                    </div>`;
                });
            }

            function openEntry() { document.getElementById('budget_entryArea').style.display='block'; }
            
            function saveTransaction() {
                const val = parseFloat(document.getElementById('budget_newInput').value);
                if(isNaN(val)) return;
                const old = getBalance();
                const profit = val - old;
                
                txs.push({ id: Date.now(), date: currentDate, bal: val, profit: profit });
                localStorage.setItem('budgetDB', JSON.stringify(txs));
                document.getElementById('budget_newInput').value = '';
                document.getElementById('budget_entryArea').style.display='none';
                updateUI();
            }

            return { init, openEntry, saveTransaction };
        })();

        // --- BOOK APP LOGIC ---
        const bookApp = (() => {
            let books = [];
            let history = [];
            let currentDate = '';

            function init() {
                const sB = localStorage.getItem('book_db_books');
                const sH = localStorage.getItem('book_db_hist');
                if(sB) books = JSON.parse(sB);
                if(sH) history = JSON.parse(sH);

                const picker = document.getElementById('books_datePicker');
                picker.addEventListener('change', () => {
                    currentDate = picker.value;
                    document.getElementById('books_displayDate').innerText = currentDate;
                    renderDaily();
                });
                renderLibrary();
                renderDaily();
            }

            function save() {
                localStorage.setItem('book_db_books', JSON.stringify(books));
                localStorage.setItem('book_db_hist', JSON.stringify(history));
            }

            function renderLibrary() {
                const div = document.getElementById('book_libraryList');
                div.innerHTML = '';
                books.forEach(b => {
                    const pct = Math.round((b.curr / b.total)*100);
                    div.innerHTML += `
                    <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px; margin-bottom:10px; display:flex; justify-content:space-between;">
                        <div>
                            <div style="font-weight:bold;">${b.title}</div>
                            <div style="font-size:12px; opacity:0.6;">${b.curr}/${b.total} (%${pct})</div>
                        </div>
                    </div>`;
                });
            }

            function renderDaily() {
                const h = history.filter(x => x.date === currentDate);
                const div = document.getElementById('book_dailyList');
                if(h.length === 0) div.innerHTML = '<span style="opacity:0.5">Bug√ºn kayƒ±t yok.</span>';
                else {
                    let html = '';
                    h.forEach(x => {
                        if(x.bookId === -1) html += '<div>üí§ Dinlenme</div>';
                        else {
                            const b = books.find(y => y.id == x.bookId);
                            html += `<div>üìñ ${b ? b.title : '?'} (+${x.pages} sf)</div>`;
                        }
                    });
                    div.innerHTML = html;
                }
            }

            function openNewBookModal() { document.getElementById('book_newModal').classList.add('open'); }
            function saveNewBook() {
                const t = document.getElementById('book_newTitle').value;
                const tot = document.getElementById('book_newTotal').value;
                if(t && tot) {
                    books.push({ id: Date.now(), title: t, total: parseInt(tot), curr: 0, status: 'reading' });
                    save(); renderLibrary();
                    document.getElementById('book_newModal').classList.remove('open');
                }
            }

            function openReadModal() {
                const sel = document.getElementById('book_selectBook');
                sel.innerHTML = '';
                books.filter(b => b.status === 'reading').forEach(b => {
                    sel.innerHTML += `<option value="${b.id}">${b.title}</option>`;
                });
                document.getElementById('book_readModal').classList.add('open');
            }
            
            function saveReading() {
                const bid = document.getElementById('book_selectBook').value;
                const p = parseInt(document.getElementById('book_pagesInput').value);
                if(bid && p) {
                    const b = books.find(x => x.id == bid);
                    if(b) {
                        b.curr += p;
                        if(b.curr >= b.total) { b.curr = b.total; b.status = 'completed'; alert("Kitap Bitti!"); }
                        history.push({ id: Date.now(), date: currentDate, bookId: bid, pages: p });
                        save(); renderLibrary(); renderDaily();
                        document.getElementById('book_readModal').classList.remove('open');
                    }
                }
            }

            function markRest() {
                history.push({ id: Date.now(), date: currentDate, bookId: -1, pages: 0 });
                save(); renderDaily();
            }

            return { init, openNewBookModal, saveNewBook, openReadModal, saveReading, markRest };
        })();

        // --- INIT ALL ---
        window.onload = () => {
            globalApp.init();
            namazApp.init();
            notesApp.init();
            engApp.init();
            budgetApp.init();
            bookApp.init();
        };

    </script>
</body>
</html>