<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kitaplƒ±k">
    <meta name="theme-color" content="#0d0d14">
    <title>Kitaplƒ±k - Pro</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #0d0d14;
            --bg-secondary: #151520;
            --bg-card: #1a1a28;
            --bg-elevated: #222233;
            --text-primary: #f5f5f7;
            --text-secondary: #a0a0b0;
            --text-muted: #6a6a7a;
            
            --accent-gold: #d4af37;
            --accent-emerald: #2dd4bf;
            --accent-rose: #f472b6;
            --accent-violet: #a78bfa;
            --accent-blue: #3b82f6;

            --border-subtle: rgba(255,255,255,0.08);
            --shadow-lg: 0 25px 50px -12px rgba(0,0,0,0.5);
            
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-xl: 28px;
            
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding-top: var(--safe-top);
            padding-bottom: calc(85px + var(--safe-bottom));
            min-height: 100vh;
        }

        /* Ambient Background */
        .ambient-bg {
            position: fixed; top: 0; left: 0; right: 0; height: 400px;
            background: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(212, 175, 55, 0.15), transparent);
            pointer-events: none; z-index: 0;
        }

        .app-container { position: relative; z-index: 1; max-width: 500px; margin: 0 auto; padding: 0 20px; }

        /* Header */
        header {
            padding: 20px 0; display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 50;
            background: linear-gradient(to bottom, var(--bg-primary) 80%, transparent);
        }
        .logo h1 { font-family: 'Cormorant Garamond', serif; font-size: 26px; font-weight: 700; background: linear-gradient(to right, #fff, #a0a0b0); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 2px; }
        .logo span { font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: var(--accent-gold); display: block; }
        .logo .signature { font-size: 9px; color: var(--text-muted); letter-spacing: 0.5px; margin-top: 4px; font-style: italic; text-transform: none; }

        .icon-btn {
            width: 40px; height: 40px; border-radius: 12px; background: var(--bg-card);
            border: 1px solid var(--border-subtle); color: var(--text-secondary);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }

        /* Hero / Currently Reading */
        .hero-section { margin-bottom: 30px; }
        .reading-card {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-elevated));
            border: 1px solid var(--border-subtle); border-radius: var(--radius-xl);
            padding: 20px; display: flex; gap: 16px; position: relative; overflow: hidden;
            box-shadow: var(--shadow-lg);
        }
        .reading-card::after {
            content:''; position: absolute; top:0; right:0; width:150px; height:100%;
            background: radial-gradient(circle at 100% 0%, rgba(45, 212, 191, 0.1), transparent 70%);
        }

        .hero-cover {
            width: 90px; height: 135px; border-radius: var(--radius-md); object-fit: cover;
            background: #2a2a35; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 30px;
        }
        .hero-cover img { width: 100%; height: 100%; object-fit: cover; border-radius: var(--radius-md); }

        .hero-info { flex: 1; display: flex; flex-direction: column; justify-content: center; z-index: 2; }
        .hero-tag { font-size: 10px; color: var(--accent-emerald); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
        .hero-tag::before { content:''; width:6px; height:6px; background: currentColor; border-radius:50%; box-shadow: 0 0 8px currentColor; }
        
        .hero-title { font-family: 'Cormorant Garamond', serif; font-size: 20px; margin-bottom: 4px; line-height: 1.2; }
        .hero-author { font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; }

        .progress-bar { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin-bottom: 6px; }
        .progress-fill { height: 100%; background: var(--accent-gold); width: 0%; transition: width 0.5s ease; }
        .progress-text { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted); }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 30px; }
        .stat-card {
            background: var(--bg-card); padding: 16px; border-radius: var(--radius-lg);
            border: 1px solid var(--border-subtle); display: flex; flex-direction: column; gap: 4px;
        }
        .stat-val { font-size: 22px; font-weight: 700; color: var(--text-primary); }
        .stat-lbl { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-card.gold .stat-val { color: var(--accent-gold); }
        .stat-card.emerald .stat-val { color: var(--accent-emerald); }
        
        /* Full width stat card for analytics */
        .stat-card-full { grid-column: span 2; background: linear-gradient(135deg, var(--bg-elevated), var(--bg-card)); }

        /* Book List */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .section-header h2 { font-family: 'Cormorant Garamond', serif; font-size: 22px; }
        .filter-btn { background: none; border: none; color: var(--accent-gold); font-size: 13px; font-weight: 500; cursor: pointer; }

        .book-list { display: flex; flex-direction: column; gap: 12px; }
        .book-item {
            background: var(--bg-card); padding: 12px; border-radius: var(--radius-lg);
            border: 1px solid var(--border-subtle); display: flex; gap: 14px; align-items: center;
        }
        .item-cover { width: 50px; height: 75px; border-radius: 8px; background: #2a2a35; flex-shrink: 0; display: flex; align-items: center; justify-content: center; overflow: hidden;}
        .item-cover img { width: 100%; height: 100%; object-fit: cover; }
        
        .item-info { flex: 1; }
        .item-title { font-weight: 600; font-size: 15px; margin-bottom: 2px; }
        .item-author { font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; }
        .status-badge { 
            font-size: 10px; padding: 3px 8px; border-radius: 12px; text-transform: uppercase; font-weight: 600; 
            background: rgba(255,255,255,0.05); color: var(--text-muted); display: inline-block;
        }
        .status-reading { background: rgba(45, 212, 191, 0.15); color: var(--accent-emerald); }
        .status-completed { background: rgba(212, 175, 55, 0.15); color: var(--accent-gold); }

        /* Analytics Goals */
        .goal-grid { display: grid; grid-template-columns: 1fr; gap: 16px; margin-bottom: 24px; }
        .goal-card {
            background: var(--bg-card); padding: 20px; border-radius: var(--radius-lg);
            border: 1px solid var(--border-subtle); display: flex; align-items: center; gap: 20px;
        }
        .ring-container { width: 60px; height: 60px; position: relative; flex-shrink: 0; }
        .ring-container svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .ring-bg { fill: none; stroke: var(--bg-elevated); stroke-width: 5; }
        .ring-val { fill: none; stroke-width: 5; stroke-linecap: round; stroke-dasharray: 150; stroke-dashoffset: 150; transition: stroke-dashoffset 1s ease; }
        
        .goal-info h3 { font-size: 14px; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; }
        .goal-numbers { font-size: 20px; font-weight: 700; color: var(--text-primary); }
        .goal-percent { font-size: 12px; color: var(--text-muted); }

        /* FAB */
        .fab {
            position: fixed; bottom: calc(90px + var(--safe-bottom)); right: 20px;
            width: 56px; height: 56px; border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-gold), #f59e0b);
            color: #000; border: none; font-size: 28px;
            box-shadow: 0 8px 24px rgba(212, 175, 55, 0.3);
            display: flex; align-items: center; justify-content: center; z-index: 90;
        }

        /* Navigation */
        .tab-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(13, 13, 20, 0.95); backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-subtle);
            display: flex; justify-content: space-around;
            padding: 12px 0 calc(12px + var(--safe-bottom)); z-index: 100;
        }
        .tab-btn {
            background: none; border: none; color: var(--text-muted);
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            font-size: 10px; font-weight: 600; flex: 1;
        }
        .tab-btn svg { width: 24px; height: 24px; }
        .tab-btn.active { color: var(--accent-gold); }

        /* Modals & Forms */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            z-index: 2000; opacity: 0; visibility: hidden; transition: all 0.3s;
            display: flex; align-items: flex-end; justify-content: center;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal {
            background: var(--bg-secondary); width: 100%; max-width: 500px;
            border-radius: 24px 24px 0 0; padding: 24px; max-height: 90vh; overflow-y: auto;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .modal-overlay.active .modal { transform: translateY(0); }

        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 11px; color: var(--text-secondary); margin-bottom: 6px; text-transform: uppercase; }
        .form-input, select, textarea {
            width: 100%; padding: 14px; background: var(--bg-card); border: 1px solid var(--border-subtle);
            border-radius: 12px; color: white; font-size: 16px; font-family: inherit;
        }
        
        /* Dark Date Picker fix */
        input[type="date"] { color-scheme: dark; }

        .cover-upload {
            height: 120px; border: 2px dashed var(--border-subtle); border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-muted); font-size: 12px; margin-bottom: 20px; cursor: pointer;
            background-size: cover; background-position: center; position: relative;
        }
        .cover-upload.has-img span, .cover-upload.has-img svg { display: none; }

        .btn-primary { width: 100%; padding: 16px; background: var(--accent-gold); border: none; border-radius: 12px; color: #000; font-weight: 700; font-size: 16px; }
        .btn-secondary { width: 100%; padding: 14px; background: var(--bg-card); border: 1px solid var(--border-subtle); color: var(--text-primary); border-radius: 12px; margin-top: 10px; }

        /* Notes List in Detail */
        .note-item { background: var(--bg-card); padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid var(--accent-gold); }
        .note-meta { font-size: 10px; color: var(--text-muted); display: flex; justify-content: space-between; margin-bottom: 4px; }
        .note-text { font-size: 13px; color: var(--text-secondary); line-height: 1.4; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="ambient-bg"></div>

    <div class="app-container">
        <header>
            <div class="logo">
                <h1>Kitaplƒ±k</h1>
                <span>Okuma Takip√ßisi</span>
                <span class="signature">Created by M. SEFA G√ñR</span>
            </div>
            <button class="icon-btn" onclick="openSettings()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            </button>
        </header>

        <main id="view-library">
            <div class="hero-section" id="heroSection">
                </div>

            <div class="stats-grid">
                <div class="stat-card gold">
                    <span class="stat-val" id="statStreak">0</span>
                    <span class="stat-lbl">G√ºn Seri üî•</span>
                </div>
                <div class="stat-card emerald">
                    <span class="stat-val" id="statYearTotal">0</span>
                    <span class="stat-lbl">Bu Yƒ±l Biten</span>
                </div>
            </div>

            <div class="section-header">
                <h2>Kitaplarƒ±m</h2>
                <button class="filter-btn" id="filterBtn">T√ºm√º ‚ñæ</button>
            </div>
            
            <div class="book-list" id="bookList">
                </div>
        </main>

        <main id="view-analytics" class="hidden">
            <div class="section-header">
                <h2>Hedefler & Analiz</h2>
            </div>
            
            <div class="stats-grid" style="margin-bottom: 20px;">
                 <div class="stat-card stat-card-full">
                    <span class="stat-val" id="statAllTimePages">0</span>
                    <span class="stat-lbl" style="color:var(--accent-blue)">Toplam Okunan Sayfa (√ñm√ºr Boyu) üìö</span>
                 </div>
            </div>

            <div class="goal-grid">
                <div class="goal-card">
                    <div class="ring-container">
                        <svg viewBox="0 0 50 50">
                            <circle class="ring-bg" cx="25" cy="25" r="20" />
                            <circle class="ring-val" id="dailyRing" cx="25" cy="25" r="20" style="stroke: var(--accent-blue)" />
                        </svg>
                    </div>
                    <div class="goal-info">
                        <h3>Bug√ºn (Sayfa)</h3>
                        <div class="goal-numbers"><span id="dailyRead">0</span> / <span id="dailyTarget">30</span></div>
                        <div class="goal-percent" id="dailyPct">%0 Tamamlandƒ±</div>
                    </div>
                </div>

                <div class="goal-card">
                    <div class="ring-container">
                        <svg viewBox="0 0 50 50">
                            <circle class="ring-bg" cx="25" cy="25" r="20" />
                            <circle class="ring-val" id="monthlyRing" cx="25" cy="25" r="20" style="stroke: var(--accent-violet)" />
                        </svg>
                    </div>
                    <div class="goal-info">
                        <h3>Bu Ay (Sayfa)</h3>
                        <div class="goal-numbers"><span id="monthlyRead">0</span> / <span id="monthlyTarget">900</span></div>
                        <div class="goal-percent" id="monthlyPct">%0 Tamamlandƒ±</div>
                    </div>
                </div>

                <div class="goal-card">
                    <div class="ring-container">
                        <svg viewBox="0 0 50 50">
                            <circle class="ring-bg" cx="25" cy="25" r="20" />
                            <circle class="ring-val" id="yearlyRing" cx="25" cy="25" r="20" style="stroke: var(--accent-gold)" />
                        </svg>
                    </div>
                    <div class="goal-info">
                        <h3>Yƒ±llƒ±k Hedef (Kitap)</h3>
                        <div class="goal-numbers"><span id="yearlyRead">0</span> / <span id="yearlyTarget">12</span></div>
                        <div class="goal-percent" id="yearlyPct">%0 Tamamlandƒ±</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <button class="fab" onclick="openAddModal()">+</button>

    <nav class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('library', this)">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
            Kitaplƒ±k
        </button>
        <button class="tab-btn" onclick="switchTab('analytics', this)">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
            Analiz
        </button>
    </nav>

    <div class="modal-overlay" id="bookModal">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h2 id="modalTitle">Kitap Ekle</h2>
                <button onclick="closeModal('bookModal')" style="background:none; border:none; color:white; font-size:24px;">&times;</button>
            </div>
            
            <form id="bookForm">
                <input type="hidden" id="bookId">
                <div class="cover-upload" id="coverDropZone" onclick="document.getElementById('coverInput').click()">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                    <span style="margin-top:8px">Kapak Fotoƒürafƒ± Ekle</span>
                    <input type="file" id="coverInput" accept="image/*" hidden onchange="handleImageUpload(this)">
                </div>

                <div class="form-group"><label>Kitap Adƒ±</label><input type="text" id="mTitle" class="form-input" required></div>
                <div class="form-group"><label>Yazar</label><input type="text" id="mAuthor" class="form-input"></div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div class="form-group"><label>Toplam Sayfa</label><input type="number" id="mPages" class="form-input" required></div>
                    <div class="form-group"><label>≈ûu Anki Sayfa</label><input type="number" id="mCurrent" class="form-input" value="0"></div>
                </div>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div class="form-group"><label>Ba≈ülangƒ±√ß Tarihi</label><input type="date" id="mStart" class="form-input"></div>
                    <div class="form-group"><label>Biti≈ü Tarihi</label><input type="date" id="mEnd" class="form-input"></div>
                </div>

                <div class="form-group"><label>Durum</label>
                    <select id="mStatus" class="form-input" onchange="handleStatusChange()">
                        <option value="reading">Okuyorum</option>
                        <option value="wishlist">Okuyacaƒüƒ±m</option>
                        <option value="completed">Tamamlandƒ±</option>
                    </select>
                </div>
                
                <button type="submit" class="btn-primary">Kaydet</button>
                <div id="editActions" class="hidden">
                    <button type="button" class="btn-secondary" onclick="openNoteModal()">üìù Not Ekle</button>
                    <button type="button" class="btn-secondary" style="color:#ef4444; border-color:rgba(239,68,68,0.3);" onclick="deleteBook()">üóë Sil</button>
                </div>
            </form>

            <div id="notesList" style="margin-top:20px;"></div>
        </div>
    </div>

    <div class="modal-overlay" id="noteModal">
        <div class="modal">
            <h2 style="margin-bottom:20px;">Not Ekle</h2>
            <form id="noteForm">
                <div class="form-group"><label>Sayfa No</label><input type="number" id="nPage" class="form-input"></div>
                <div class="form-group"><label>Notunuz</label><textarea id="nContent" class="form-input" rows="4" required></textarea></div>
                <button type="submit" class="btn-primary">Notu Kaydet</button>
                <button type="button" class="btn-secondary" onclick="closeModal('noteModal')">ƒ∞ptal</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="progressModal">
        <div class="modal">
            <h2 style="margin-bottom:10px;">ƒ∞lerleme</h2>
            <p id="progBookTitle" style="color:var(--text-secondary); margin-bottom:20px;"></p>
            <form id="progressForm">
                <input type="hidden" id="progBookId">
                <div class="form-group"><label>Ka√ßƒ±ncƒ± Sayfadasƒ±n?</label><input type="number" id="progCurrentPage" class="form-input" required></div>
                <button type="submit" class="btn-primary">G√ºncelle</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <h2 style="margin-bottom:20px;">Ayarlar</h2>
            <div class="form-group">
                <label>G√ºnl√ºk Hedef (Sayfa)</label>
                <input type="number" id="setDaily" class="form-input">
            </div>
            <div class="form-group">
                <label>Yƒ±llƒ±k Hedef (Kitap)</label>
                <input type="number" id="setYearly" class="form-input">
            </div>
            <hr style="border:0; border-top:1px solid var(--border-subtle); margin:20px 0;">
            <div class="form-group">
                <label>Veri Yedekleme</label>
                <button onclick="exportData()" class="btn-secondary">‚¨áÔ∏è Yedek ƒ∞ndir (JSON)</button>
                <button onclick="document.getElementById('importFile').click()" class="btn-secondary">‚¨ÜÔ∏è Yedek Y√ºkle</button>
                <input type="file" id="importFile" hidden onchange="importData(this)">
            </div>
            <button class="btn-secondary" onclick="closeModal('settingsModal')">Kapat</button>
        </div>
    </div>

    <script>
        // --- DATA STATE ---
        let books = JSON.parse(localStorage.getItem('books_pro')) || [];
        let settings = JSON.parse(localStorage.getItem('settings_pro')) || { dailyGoal: 30, yearlyGoal: 12 };
        let currentFilter = 'all';
        let currentCoverImg = null;

        // --- MIGRATION UTILS ---
        books.forEach(b => {
            if(!b.history) b.history = [];
            if(!b.notes) b.notes = [];
            if(!b.startDate) b.startDate = null; // New Field
            if(!b.endDate) b.endDate = null;
        });

        function saveData() {
            localStorage.setItem('books_pro', JSON.stringify(books));
            localStorage.setItem('settings_pro', JSON.stringify(settings));
            renderAll();
        }

        function renderAll() {
            renderHero();
            renderList();
            renderAnalytics();
            updateStats();
        }

        // --- UI RENDERING ---

        function renderHero() {
            const hero = document.getElementById('heroSection');
            const reading = books.filter(b => b.status === 'reading')
                                 .sort((a,b) => b.lastUpdated - a.lastUpdated); 

            if (reading.length === 0) {
                hero.innerHTML = `
                    <div class="reading-card" onclick="openAddModal()" style="align-items:center; justify-content:center; padding:30px;">
                        <div style="text-align:center; opacity:0.6;">
                            <div style="font-size:32px; margin-bottom:10px;">üìö</div>
                            <div>≈ûu an okuduƒüun kitap yok</div>
                            <div style="font-size:12px; color:var(--accent-gold); margin-top:5px;">+ Ba≈ülamak i√ßin tƒ±kla</div>
                        </div>
                    </div>`;
                return;
            }

            const book = reading[0];
            const pct = Math.round((book.currentPage / book.totalPages) * 100);
            
            hero.innerHTML = `
                <div class="reading-card" onclick="openProgressModal(${book.id})">
                    <div class="hero-cover">${book.cover ? `<img src="${book.cover}">` : 'üìñ'}</div>
                    <div class="hero-info">
                        <div class="hero-tag">Okumaya Devam Et</div>
                        <h3 class="hero-title">${book.title}</h3>
                        <div class="hero-author">${book.author}</div>
                        <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
                        <div class="progress-text">
                            <span>Sayfa ${book.currentPage} / ${book.totalPages}</span>
                            <span>%${pct}</span>
                        </div>
                    </div>
                </div>`;
        }

        function renderList() {
            const list = document.getElementById('bookList');
            const btn = document.getElementById('filterBtn');
            const map = {all:'T√ºm√º', reading:'Okuyor', completed:'Bitti', wishlist:'ƒ∞stek'};
            btn.innerText = map[currentFilter] + ' ‚ñæ';

            let items = books;
            if(currentFilter !== 'all') items = books.filter(b => b.status === currentFilter);
            
            items.sort((a,b) => {
                if(a.status === 'reading' && b.status !== 'reading') return -1;
                if(b.status === 'reading' && a.status !== 'reading') return 1;
                return b.id - a.id;
            });

            if(items.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding:30px; color:var(--text-muted); font-size:13px;">Bu listede kitap yok.</div>`;
                return;
            }

            list.innerHTML = items.map(b => `
                <div class="book-item" onclick="openEditModal(${b.id})">
                    <div class="item-cover">${b.cover ? `<img src="${b.cover}">` : 'üìò'}</div>
                    <div class="item-info">
                        <div class="item-title">${b.title}</div>
                        <div class="item-author">${b.author}</div>
                        <span class="status-badge status-${b.status}">${map[b.status]}</span>
                        <span style="font-size:11px; color:var(--text-muted); margin-left:8px;">‚Ä¢ ${b.currentPage} syf</span>
                    </div>
                    ${b.status === 'reading' ? `<button onclick="event.stopPropagation(); openProgressModal(${b.id})" style="width:32px; height:32px; border-radius:50%; background:var(--bg-elevated); border:1px solid var(--border-subtle); color:var(--accent-gold);">‚ö°Ô∏è</button>` : ''}
                </div>
            `).join('');
        }

        function updateStats() {
            let streak = 0;
            const today = new Date().toISOString().split('T')[0];
            const readDates = new Set();
            books.forEach(b => b.history.forEach(h => readDates.add(h.date)));
            
            if(readDates.has(today)) streak = 1;
            let d = new Date();
            d.setDate(d.getDate() - 1);
            while(true) {
                const dateStr = d.toISOString().split('T')[0];
                if(readDates.has(dateStr)) {
                    streak++; d.setDate(d.getDate() - 1);
                } else {
                    if(streak === 0 && readDates.has(today)) { /* continue */ }
                    else if (streak > 0 && !readDates.has(today) && !readDates.has(dateStr)) { break; } 
                    else if (!readDates.has(dateStr)) break;
                }
                if(streak > 365) break;
            }
            document.getElementById('statStreak').innerText = streak;

            const thisYear = new Date().getFullYear().toString();
            const yearCount = books.filter(b => b.status === 'completed' && b.endDate && b.endDate.startsWith(thisYear)).length;
            document.getElementById('statYearTotal').innerText = yearCount;
        }

        // --- ANALYTICS ENGINE ---
        function renderAnalytics() {
            const today = new Date().toISOString().split('T')[0];
            const now = new Date();
            const monthStr = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            const yearStr = new Date(now.getFullYear(), 0, 1).toISOString().split('T')[0];

            let dRead = 0, mRead = 0, yCount = 0;
            let allTimePages = 0;

            books.forEach(b => {
                if(b.status === 'completed') {
                    if(b.endDate >= yearStr) yCount++;
                    allTimePages += (b.totalPages || 0);
                }
                b.history.forEach(h => {
                    if(h.date === today) dRead += h.pagesRead;
                    if(h.date >= monthStr) mRead += h.pagesRead;
                });
            });

            updateRing('dailyRing', dRead, settings.dailyGoal, 'dailyPct', 'dailyRead', 'dailyTarget');
            updateRing('monthlyRing', mRead, settings.dailyGoal * 30, 'monthlyPct', 'monthlyRead', 'monthlyTarget');
            updateRing('yearlyRing', yCount, settings.yearlyGoal, 'yearlyPct', 'yearlyRead', 'yearlyTarget');
            
            // New Stat: Total Pages
            document.getElementById('statAllTimePages').innerText = allTimePages.toLocaleString('tr-TR');
        }

        function updateRing(id, val, max, txtId, valId, maxId) {
            const circle = document.getElementById(id);
            const pct = Math.min(100, Math.round((val/max)*100));
            const offset = 150 - (pct/100)*150;
            circle.style.strokeDashoffset = offset;
            document.getElementById(txtId).innerText = `%${pct} Tamamlandƒ±`;
            document.getElementById(valId).innerText = val;
            document.getElementById(maxId).innerText = max;
        }

        // --- IMAGE HANDLING ---
        function handleImageUpload(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX_WIDTH = 300;
                    let width = img.width;
                    let height = img.height;
                    if(width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    currentCoverImg = canvas.toDataURL('image/jpeg', 0.7);
                    
                    const drop = document.getElementById('coverDropZone');
                    drop.style.backgroundImage = `url(${currentCoverImg})`;
                    drop.classList.add('has-img');
                }
                img.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }

        // --- INTERACTION LOGIC ---

        function handleStatusChange() {
            const status = document.getElementById('mStatus').value;
            const endInput = document.getElementById('mEnd');
            if(status === 'completed' && !endInput.value) {
                endInput.value = new Date().toISOString().split('T')[0];
            }
        }

        function openAddModal() {
            document.getElementById('bookForm').reset();
            document.getElementById('bookId').value = '';
            document.getElementById('modalTitle').innerText = 'Yeni Kitap Ekle';
            document.getElementById('editActions').classList.add('hidden');
            document.getElementById('notesList').innerHTML = '';
            
            // Default Start Date Today
            document.getElementById('mStart').value = new Date().toISOString().split('T')[0];

            currentCoverImg = null;
            const drop = document.getElementById('coverDropZone');
            drop.style.backgroundImage = '';
            drop.classList.remove('has-img');
            
            openModal('bookModal');
        }

        function openEditModal(id) {
            const book = books.find(b => b.id === id);
            if(!book) return;

            document.getElementById('bookId').value = book.id;
            document.getElementById('mTitle').value = book.title;
            document.getElementById('mAuthor').value = book.author;
            document.getElementById('mPages').value = book.totalPages;
            document.getElementById('mCurrent').value = book.currentPage;
            document.getElementById('mStatus').value = book.status;
            document.getElementById('mStart').value = book.startDate || '';
            document.getElementById('mEnd').value = book.endDate || '';
            
            document.getElementById('modalTitle').innerText = 'Kitabƒ± D√ºzenle';
            document.getElementById('editActions').classList.remove('hidden');

            currentCoverImg = book.cover;
            const drop = document.getElementById('coverDropZone');
            if(book.cover) {
                drop.style.backgroundImage = `url(${book.cover})`;
                drop.classList.add('has-img');
            } else {
                drop.style.backgroundImage = '';
                drop.classList.remove('has-img');
            }

            const notesDiv = document.getElementById('notesList');
            if(book.notes && book.notes.length > 0) {
                notesDiv.innerHTML = '<h3 style="font-size:14px; color:var(--text-secondary); margin-bottom:10px;">Notlar</h3>' + 
                book.notes.map(n => `
                    <div class="note-item">
                        <div class="note-meta"><span>Sayfa ${n.page}</span><span>${n.date}</span></div>
                        <div class="note-text">${n.content}</div>
                    </div>
                `).join('');
            } else {
                notesDiv.innerHTML = '';
            }

            openModal('bookModal');
        }

        document.getElementById('bookForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('bookId').value;
            const title = document.getElementById('mTitle').value;
            const author = document.getElementById('mAuthor').value;
            const total = parseInt(document.getElementById('mPages').value);
            const current = parseInt(document.getElementById('mCurrent').value);
            const status = document.getElementById('mStatus').value;
            const sDate = document.getElementById('mStart').value;
            const eDate = document.getElementById('mEnd').value;
            
            if(id) {
                // Edit
                const b = books.find(b => b.id == id);
                b.title = title; b.author = author; b.totalPages = total;
                b.cover = currentCoverImg;
                b.startDate = sDate;
                b.endDate = eDate;
                
                // Manual progress logging
                if(current > b.currentPage) {
                     const diff = current - b.currentPage;
                     const today = new Date().toISOString().split('T')[0];
                     const h = b.history.find(x => x.date === today);
                     if(h) h.pagesRead += diff;
                     else b.history.push({date: today, pagesRead: diff});
                }
                b.currentPage = current;
                
                if(status === 'completed' && b.status !== 'completed') {
                    if(!b.endDate) b.endDate = new Date().toISOString().split('T')[0];
                    b.currentPage = total;
                }
                b.status = status;
                b.lastUpdated = Date.now();

            } else {
                // New
                const newBook = {
                    id: Date.now(),
                    title, author, totalPages: total, currentPage: current, status,
                    startDate: sDate, endDate: eDate,
                    cover: currentCoverImg,
                    history: [], notes: [],
                    lastUpdated: Date.now()
                };
                if(status === 'completed' && !newBook.endDate) newBook.endDate = new Date().toISOString().split('T')[0];
                books.push(newBook);
                currentFilter = 'all'; 
            }
            saveData();
            closeModal('bookModal');
        });

        // Notes Logic
        function openNoteModal() {
            closeModal('bookModal'); 
            setTimeout(() => {
                document.getElementById('noteForm').reset();
                const id = document.getElementById('bookId').value;
                const book = books.find(b => b.id == id);
                if(book) document.getElementById('nPage').value = book.currentPage;
                openModal('noteModal');
            }, 300);
        }

        document.getElementById('noteForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('bookId').value;
            const book = books.find(b => b.id == id);
            if(book) {
                const note = {
                    id: Date.now(),
                    page: document.getElementById('nPage').value,
                    content: document.getElementById('nContent').value,
                    date: new Date().toLocaleDateString('tr-TR')
                };
                book.notes.push(note);
                saveData();
                closeModal('noteModal');
                setTimeout(() => openEditModal(id), 300);
            }
        });

        function deleteBook() {
            if(confirm('Kitabƒ± ve t√ºm notlarƒ± silmek istediƒüine emin misin?')) {
                const id = document.getElementById('bookId').value;
                books = books.filter(b => b.id != id);
                saveData();
                closeModal('bookModal');
            }
        }

        // Progress Logic
        function openProgressModal(id) {
            const book = books.find(b => b.id === id);
            document.getElementById('progBookId').value = id;
            document.getElementById('progBookTitle').innerText = book.title;
            document.getElementById('progCurrentPage').value = book.currentPage;
            openModal('progressModal');
        }

        document.getElementById('progressForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('progBookId').value;
            const newPage = parseInt(document.getElementById('progCurrentPage').value);
            const book = books.find(b => b.id == id);
            
            if(book && newPage > book.currentPage) {
                const diff = newPage - book.currentPage;
                const today = new Date().toISOString().split('T')[0];
                
                const h = book.history.find(x => x.date === today);
                if(h) h.pagesRead += diff;
                else book.history.push({date: today, pagesRead: diff});

                book.currentPage = newPage;
                book.lastUpdated = Date.now();
                
                if(book.currentPage >= book.totalPages) {
                    book.status = 'completed';
                    if(!book.endDate) book.endDate = today;
                    alert('Tebrikler! Kitabƒ± bitirdin. üéâ');
                }
                saveData();
                closeModal('progressModal');
            } else {
                 closeModal('progressModal');
            }
        });

        // Settings Logic
        function openSettings() {
            document.getElementById('setDaily').value = settings.dailyGoal;
            document.getElementById('setYearly').value = settings.yearlyGoal;
            openModal('settingsModal');
        }
        
        document.getElementById('setDaily').addEventListener('change', (e) => { settings.dailyGoal = parseInt(e.target.value); saveData(); });
        document.getElementById('setYearly').addEventListener('change', (e) => { settings.yearlyGoal = parseInt(e.target.value); saveData(); });

        document.getElementById('filterBtn').addEventListener('click', () => {
            const arr = ['all','reading','completed','wishlist'];
            const idx = arr.indexOf(currentFilter);
            currentFilter = arr[(idx+1)%arr.length];
            renderList();
        });

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        window.switchTab = function(tab, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(tab === 'library') {
                document.getElementById('view-library').classList.remove('hidden');
                document.getElementById('view-analytics').classList.add('hidden');
                renderHero();
            } else {
                document.getElementById('view-library').classList.add('hidden');
                document.getElementById('view-analytics').classList.remove('hidden');
                renderAnalytics();
            }
        }

        window.exportData = function() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({books, settings}));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", "kitaplik_pro_yedek.json");
            document.body.appendChild(node); node.click(); node.remove();
        }

        window.importData = function(input) {
            const file = input.files[0];
            if(!file) return;
            const r = new FileReader();
            r.onload = function(e) {
                try {
                    const d = JSON.parse(e.target.result);
                    if(d.books && d.settings) {
                        if(confirm('Mevcut veriler silinip yedek y√ºklenecek?')) {
                            books = d.books; settings = d.settings;
                            saveData(); alert('Y√ºklendi!'); closeModal('settingsModal');
                        }
                    }
                } catch(err) { alert('Hata: Dosya bozuk.'); }
            };
            r.readAsText(file);
        }

        renderAll();
    </script>
</body>
</html>
