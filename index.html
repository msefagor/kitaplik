<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kitaplƒ±k">
    <meta name="theme-color" content="#1a1a2e">
    <title>Kitaplƒ±k - Premium Takip</title>
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%231a1a2e' width='100' height='100' rx='20'/><text y='.9em' x='50%' text-anchor='middle' font-size='70'>üìö</text></svg>">
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #0f0f13;
            --bg-secondary: #16161e;
            --bg-card: #1c1c26;
            --bg-elevated: #252532;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            
            /* Premium Palette */
            --accent-gold: #fbbf24;
            --accent-gold-dim: rgba(251, 191, 36, 0.15);
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-purple: #8b5cf6;
            --accent-red: #ef4444;
            
            --border-subtle: rgba(255,255,255,0.08);
            --shadow-lg: 0 10px 30px -10px rgba(0,0,0,0.5);
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding-top: var(--safe-top);
            padding-bottom: calc(90px + var(--safe-bottom));
            overflow-x: hidden;
        }

        /* Ambient Background */
        .ambient-bg {
            position: fixed;
            top: 0; left: 0; right: 0; height: 50vh;
            background: radial-gradient(circle at 50% -20%, rgba(59, 130, 246, 0.08), transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        .app-container {
            position: relative;
            z-index: 1;
            max-width: 600px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            position: sticky;
            top: 0;
            background: rgba(15, 15, 19, 0.85);
            backdrop-filter: blur(12px);
            z-index: 50;
            margin-top: var(--safe-top);
        }

        .app-title h1 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(to right, #fff, #a1a1aa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .app-title span {
            font-size: 11px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--accent-gold);
            display: block;
            margin-top: -4px;
        }

        .icon-btn {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }

        /* Hero: Currently Reading Swiper Style */
        .hero-section {
            margin-bottom: 30px;
        }

        .reading-card {
            background: linear-gradient(145deg, var(--bg-card), var(--bg-elevated));
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            padding: 20px;
            display: flex;
            gap: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            margin-bottom: 16px;
        }
        
        .reading-card::after {
            content: ''; position: absolute; top: 0; right: 0; width: 100px; height: 100%;
            background: linear-gradient(to left, var(--bg-card), transparent);
            opacity: 0.1;
            pointer-events: none;
        }

        .book-cover-lg {
            width: 90px; height: 135px;
            border-radius: var(--radius-md);
            object-fit: cover;
            background: #2a2a35;
            flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            font-size: 32px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .book-cover-lg img { width: 100%; height: 100%; border-radius: var(--radius-md); object-fit: cover; }

        .reading-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        
        .reading-tag {
            font-size: 10px; text-transform: uppercase; letter-spacing: 1px;
            color: var(--accent-green); font-weight: 700; margin-bottom: 8px;
            display: flex; align-items: center; gap: 4px;
        }
        .reading-tag::before { content: ''; width: 6px; height: 6px; background: currentColor; border-radius: 50%; }

        .reading-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 22px; line-height: 1.2; margin-bottom: 4px;
            font-weight: 600;
        }
        .reading-author { font-size: 13px; color: var(--text-secondary); margin-bottom: 16px; }

        .progress-container { margin-top: auto; }
        .progress-track { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin-bottom: 6px; }
        .progress-fill { height: 100%; background: var(--accent-gold); border-radius: 3px; transition: width 0.5s ease; }
        .progress-stats { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-muted); font-weight: 500; }

        /* Stats Grid */
        .stats-row {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;
            margin-bottom: 30px;
        }
        .mini-stat {
            background: var(--bg-card); padding: 16px; border-radius: var(--radius-lg);
            border: 1px solid var(--border-subtle);
            display: flex; flex-direction: column; gap: 4px;
        }
        .mini-stat .val { font-size: 24px; font-weight: 700; color: var(--text-primary); }
        .mini-stat .lbl { font-size: 12px; color: var(--text-muted); }

        /* Book List */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .section-header h2 { font-family: 'Cormorant Garamond', serif; font-size: 22px; }
        .filter-btn { background: none; border: none; color: var(--accent-gold); font-size: 13px; font-weight: 600; cursor: pointer; }

        .book-list { display: flex; flex-direction: column; gap: 12px; padding-bottom: 20px; }
        .book-item {
            background: var(--bg-card); padding: 12px; border-radius: var(--radius-lg);
            display: flex; gap: 14px; align-items: center;
            border: 1px solid var(--border-subtle);
            transition: transform 0.2s;
        }
        .book-item:active { transform: scale(0.98); }
        
        .item-cover {
            width: 50px; height: 75px; border-radius: 8px; background: #2a2a35;
            display: flex; align-items: center; justify-content: center; font-size: 20px;
            flex-shrink: 0;
        }
        .item-cover img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
        
        .item-info { flex: 1; }
        .item-title { font-weight: 600; font-size: 15px; margin-bottom: 2px; }
        .item-author { font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; }
        .item-meta { display: flex; gap: 10px; font-size: 11px; color: var(--text-muted); }
        
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .status-reading { background: var(--accent-green); box-shadow: 0 0 8px rgba(16, 185, 129, 0.4); }
        .status-completed { background: var(--accent-gold); }
        .status-wishlist { background: var(--accent-purple); }

        /* Analytics Specific */
        .analytics-grid { display: grid; grid-template-columns: 1fr; gap: 16px; margin-bottom: 24px; }
        
        .goal-card {
            background: var(--bg-card); padding: 20px; border-radius: var(--radius-lg);
            border: 1px solid var(--border-subtle);
        }
        
        .goal-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .goal-header h3 { font-size: 15px; font-weight: 600; color: var(--text-secondary); }
        
        .goal-visual { display: flex; align-items: center; justify-content: space-between; gap: 15px; }
        
        .progress-ring { position: relative; width: 60px; height: 60px; }
        .progress-ring svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .progress-ring circle { fill: none; stroke-width: 5; stroke-linecap: round; }
        .bg-ring { stroke: var(--bg-elevated); }
        .val-ring { stroke: var(--accent-blue); transition: stroke-dashoffset 1s ease; }
        
        .goal-text { flex: 1; }
        .goal-main-val { font-size: 20px; font-weight: 700; }
        .goal-sub-val { font-size: 12px; color: var(--text-muted); }

        /* FAB */
        .fab {
            position: fixed; bottom: calc(90px + var(--safe-bottom)); right: 20px;
            width: 56px; height: 56px; border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-gold), #f59e0b);
            color: #000; border: none; font-size: 28px;
            box-shadow: 0 8px 20px rgba(251, 191, 36, 0.3);
            z-index: 90; display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.9); }

        /* Modals */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px);
            z-index: 2000; opacity: 0; visibility: hidden; transition: all 0.3s;
            display: flex; align-items: flex-end; justify-content: center;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        
        .modal {
            background: var(--bg-secondary); width: 100%; max-width: 600px;
            border-radius: 24px 24px 0 0; padding: 24px;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 90vh; overflow-y: auto; border-top: 1px solid var(--border-subtle);
        }
        .modal-overlay.active .modal { transform: translateY(0); }

        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-input {
            width: 100%; padding: 14px; background: var(--bg-card); border: 1px solid var(--border-subtle);
            border-radius: 10px; color: white; font-size: 16px; font-family: inherit;
        }
        .form-input:focus { border-color: var(--accent-gold); outline: none; }
        
        .btn-primary {
            width: 100%; padding: 16px; background: var(--accent-gold); border: none;
            border-radius: 12px; color: #000; font-weight: 600; font-size: 16px; margin-top: 10px;
        }

        .btn-danger {
             width: 100%; padding: 14px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3);
             color: var(--accent-red); border-radius: 12px; margin-top: 12px;
        }

        /* Tab Bar */
        .tab-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(15, 15, 19, 0.9); backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-subtle);
            display: flex; justify-content: space-around;
            padding: 12px 0 calc(12px + var(--safe-bottom));
            z-index: 1000;
        }
        .tab-btn {
            background: none; border: none; color: var(--text-muted);
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            font-size: 10px; font-weight: 600; width: 60px;
        }
        .tab-btn svg { width: 24px; height: 24px; }
        .tab-btn.active { color: var(--accent-gold); }

        /* Hidden Classes */
        .hidden { display: none !important; }
        
        /* Settings Modal Specific */
        .settings-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 0; border-bottom: 1px solid var(--border-subtle);
        }
        .settings-row input { width: 80px; text-align: center; }

    </style>
</head>
<body>

    <div class="ambient-bg"></div>

    <div class="app-container">
        <header>
            <div class="app-title">
                <h1>Kitaplƒ±k</h1>
                <span>Okuma Asistanƒ±</span>
            </div>
            <button class="icon-btn" id="settingsBtn">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
            </button>
        </header>

        <main id="view-library">
            <div class="hero-section" id="heroSection">
                </div>

            <div class="section-header">
                <h2>Kitaplarƒ±m</h2>
                <button class="filter-btn" id="filterBtn">T√ºm√º ‚ñæ</button>
            </div>
            
            <div class="book-list" id="bookList">
                </div>
        </main>

        <main id="view-analytics" class="hidden">
            <div class="section-header">
                <h2>Analiz & Hedefler</h2>
            </div>
            
            <div class="analytics-grid">
                <div class="goal-card">
                    <div class="goal-header">
                        <h3>G√úNL√úK HEDEF (SAYFA)</h3>
                    </div>
                    <div class="goal-visual">
                        <div class="progress-ring">
                            <svg>
                                <circle class="bg-ring" cx="30" cy="30" r="26"></circle>
                                <circle class="val-ring" id="dailyRing" cx="30" cy="30" r="26" stroke-dasharray="163" stroke-dashoffset="163"></circle>
                            </svg>
                        </div>
                        <div class="goal-text">
                            <div class="goal-main-val"><span id="dailyRead">0</span> / <span id="dailyTarget">30</span></div>
                            <div class="goal-sub-val" id="dailyPercent">%0 Tamamlandƒ±</div>
                        </div>
                    </div>
                </div>

                <div class="goal-card">
                    <div class="goal-header">
                        <h3>BU HAFTA (SAYFA)</h3>
                    </div>
                    <div class="goal-visual">
                        <div class="progress-ring">
                            <svg>
                                <circle class="bg-ring" cx="30" cy="30" r="26" stroke="#252532"></circle>
                                <circle class="val-ring" id="weeklyRing" cx="30" cy="30" r="26" stroke-dasharray="163" stroke-dashoffset="163" style="stroke: var(--accent-green)"></circle>
                            </svg>
                        </div>
                        <div class="goal-text">
                            <div class="goal-main-val"><span id="weeklyRead">0</span> / <span id="weeklyTarget">210</span></div>
                            <div class="goal-sub-val" id="weeklyPercent">%0 Tamamlandƒ±</div>
                        </div>
                    </div>
                </div>

                <div class="goal-card">
                    <div class="goal-header">
                        <h3>BU AY (SAYFA)</h3>
                    </div>
                    <div class="goal-visual">
                        <div class="progress-ring">
                            <svg>
                                <circle class="bg-ring" cx="30" cy="30" r="26"></circle>
                                <circle class="val-ring" id="monthlyRing" cx="30" cy="30" r="26" stroke-dasharray="163" stroke-dashoffset="163" style="stroke: var(--accent-purple)"></circle>
                            </svg>
                        </div>
                        <div class="goal-text">
                            <div class="goal-main-val"><span id="monthlyRead">0</span> / <span id="monthlyTarget">900</span></div>
                            <div class="goal-sub-val" id="monthlyPercent">%0 Tamamlandƒ±</div>
                        </div>
                    </div>
                </div>

                <div class="goal-card">
                    <div class="goal-header">
                        <h3>YILLIK Kƒ∞TAP HEDEFƒ∞</h3>
                    </div>
                    <div class="goal-visual">
                        <div class="progress-ring">
                            <svg>
                                <circle class="bg-ring" cx="30" cy="30" r="26"></circle>
                                <circle class="val-ring" id="yearlyRing" cx="30" cy="30" r="26" stroke-dasharray="163" stroke-dashoffset="163" style="stroke: var(--accent-gold)"></circle>
                            </svg>
                        </div>
                        <div class="goal-text">
                            <div class="goal-main-val"><span id="yearlyRead">0</span> / <span id="yearlyTarget">12</span></div>
                            <div class="goal-sub-val" id="yearlyPercent">%0 Tamamlandƒ±</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="stats-row">
                 <div class="mini-stat">
                     <span class="val" id="statStreak">0</span>
                     <span class="lbl">G√ºn Seri</span>
                 </div>
                 <div class="mini-stat">
                     <span class="val" id="statTotalBooks">0</span>
                     <span class="lbl">Toplam Kitap</span>
                 </div>
            </div>
        </main>
    </div>

    <button class="fab" id="fabBtn">+</button>

    <nav class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('library')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
            Kitaplƒ±k
        </button>
        <button class="tab-btn" onclick="switchTab('analytics')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
            Analiz
        </button>
    </nav>

    <div class="modal-overlay" id="bookModal">
        <div class="modal">
            <div class="section-header">
                <h2 id="modalTitle">Kitap Ekle</h2>
                <button onclick="closeModal('bookModal')" style="background:none; border:none; color:var(--text-secondary); font-size:24px;">&times;</button>
            </div>
            <form id="bookForm">
                <input type="hidden" id="bookId">
                <div class="form-group">
                    <label>Kitap Adƒ±</label>
                    <input type="text" id="mTitle" class="form-input" required placeholder="Kitabƒ±n adƒ±">
                </div>
                <div class="form-group">
                    <label>Yazar</label>
                    <input type="text" id="mAuthor" class="form-input" placeholder="Yazar adƒ±">
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                    <div class="form-group">
                        <label>Toplam Sayfa</label>
                        <input type="number" id="mPages" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label>≈ûu Anki Sayfa</label>
                        <input type="number" id="mCurrent" class="form-input" value="0">
                    </div>
                </div>
                <div class="form-group">
                    <label>Durum</label>
                    <select id="mStatus" class="form-input">
                        <option value="reading">Okuyorum</option>
                        <option value="wishlist">Okuyacaƒüƒ±m</option>
                        <option value="completed">Tamamlandƒ±</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">Kaydet</button>
                <button type="button" id="btnDelete" class="btn-danger hidden" onclick="deleteBook()">Kitabƒ± Sil</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="progressModal">
        <div class="modal">
            <div class="section-header">
                <h2>ƒ∞lerleme G√ºncelle</h2>
                <button onclick="closeModal('progressModal')" style="background:none; border:none; color:var(--text-secondary); font-size:24px;">&times;</button>
            </div>
            <p id="progBookTitle" style="color:var(--text-muted); margin-bottom:20px; font-family:'Cormorant Garamond', serif; font-size:18px;"></p>
            <form id="progressForm">
                <input type="hidden" id="progBookId">
                <div class="form-group">
                    <label>Ka√ßƒ±ncƒ± Sayfadasƒ±n?</label>
                    <input type="number" id="progCurrentPage" class="form-input" required>
                </div>
                <button type="submit" class="btn-primary">G√ºncelle</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="section-header">
                <h2>Ayarlar</h2>
                <button onclick="closeModal('settingsModal')" style="background:none; border:none; color:var(--text-secondary); font-size:24px;">&times;</button>
            </div>
            
            <div class="settings-row">
                <label>G√ºnl√ºk Sayfa Hedefi</label>
                <input type="number" id="setDailyGoal" class="form-input" value="30">
            </div>
            <div class="settings-row">
                <label>Yƒ±llƒ±k Kitap Hedefi</label>
                <input type="number" id="setYearlyGoal" class="form-input" value="12">
            </div>

            <hr style="border:0; border-top:1px solid var(--border-subtle); margin: 20px 0;">

            <div class="form-group">
                <label>Veri Yedekleme</label>
                <button onclick="exportData()" class="btn-primary" style="background: var(--bg-elevated); border: 1px solid var(--border-subtle); color: var(--text-primary); margin-bottom: 8px;">üíæ Verileri ƒ∞ndir (Yedekle)</button>
                <button onclick="document.getElementById('importFile').click()" class="btn-primary" style="background: var(--bg-elevated); border: 1px solid var(--border-subtle); color: var(--text-primary);">üìÇ Verileri Geri Y√ºkle</button>
                <input type="file" id="importFile" style="display:none" onchange="importData(this)">
            </div>
            
            <div style="font-size: 10px; color: var(--text-muted); text-align: center; margin-top: 20px;">
                Version 2.1 ‚Ä¢ iOS Optimized
            </div>
        </div>
    </div>

    <script>
        // --- DATA STRUCTURE ---
        // books: [ { id, title, author, totalPages, currentPage, status, history: [ {date: 'YYYY-MM-DD', pagesRead: 10} ] } ]
        // settings: { dailyGoal: 30, yearlyGoal: 12 }
        
        let books = JSON.parse(localStorage.getItem('books_v2')) || [];
        let settings = JSON.parse(localStorage.getItem('settings_v2')) || { dailyGoal: 30, yearlyGoal: 12 };
        let currentFilter = 'all';

        // --- MIGRATION (from old structure if exists) ---
        function migrateData() {
            const oldBooks = JSON.parse(localStorage.getItem('books'));
            if (oldBooks && books.length === 0) {
                books = oldBooks.map(b => ({
                    ...b,
                    history: [] // Add history array to legacy data
                }));
                saveData();
                // Clear old key to prevent re-migration
                localStorage.removeItem('books'); 
            }
        }
        migrateData();

        // --- CORE FUNCTIONS ---
        function saveData() {
            localStorage.setItem('books_v2', JSON.stringify(books));
            localStorage.setItem('settings_v2', JSON.stringify(settings));
            renderAll();
        }

        function renderAll() {
            renderHero();
            renderList();
            renderAnalytics();
        }

        // --- RENDER HERO (Currently Reading) ---
        function renderHero() {
            const hero = document.getElementById('heroSection');
            // Find most recently interacted reading book or just first reading book
            const readingBooks = books.filter(b => b.status === 'reading');
            
            if (readingBooks.length === 0) {
                hero.innerHTML = `
                    <div class="reading-card" onclick="openAddModal()" style="justify-content:center; align-items:center; opacity:0.7;">
                        <div style="text-align:center; padding: 20px;">
                            <div style="font-size:40px; margin-bottom:10px;">üìö</div>
                            <div>≈ûu an okuduƒüun bir kitap yok.</div>
                            <div style="color:var(--accent-gold); font-size:13px; margin-top:5px;">+ Ba≈ülamak i√ßin tƒ±kla</div>
                        </div>
                    </div>`;
                return;
            }

            // Show the first one (or we could make a slider, but simpler is better for stability)
            const book = readingBooks[0]; 
            const percent = Math.round((book.currentPage / book.totalPages) * 100) || 0;
            
            hero.innerHTML = `
                <div class="reading-card" onclick="openProgressModal(${book.id})">
                    <div class="book-cover-lg">
                        ${book.cover ? `<img src="${book.cover}">` : 'üìñ'}
                    </div>
                    <div class="reading-info">
                        <div class="reading-tag">Okumaya Devam Et</div>
                        <h3 class="reading-title">${book.title}</h3>
                        <div class="reading-author">${book.author}</div>
                        
                        <div class="progress-container">
                            <div class="progress-track">
                                <div class="progress-fill" style="width: ${percent}%"></div>
                            </div>
                            <div class="progress-stats">
                                <span>Sayfa ${book.currentPage}</span>
                                <span>${percent}%</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- RENDER LIST ---
        function renderList() {
            const list = document.getElementById('bookList');
            const btn = document.getElementById('filterBtn');
            
            const labels = { all: 'T√ºm√º', reading: 'Okuyor', completed: 'Bitti', wishlist: 'ƒ∞stek' };
            btn.innerText = labels[currentFilter] + ' ‚ñæ';

            let filtered = books;
            if (currentFilter !== 'all') {
                filtered = books.filter(b => b.status === currentFilter);
            }
            // Sort: Reading first, then by ID (newest)
            filtered.sort((a,b) => {
                if(a.status === 'reading' && b.status !== 'reading') return -1;
                if(b.status === 'reading' && a.status !== 'reading') return 1;
                return b.id - a.id;
            });

            if (filtered.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-muted);">Bu filtrede kitap yok.</div>`;
                return;
            }

            list.innerHTML = filtered.map(b => {
                return `
                <div class="book-item" onclick="openEditModal(${b.id})">
                    <div class="item-cover">${b.cover ? `<img src="${b.cover}">` : 'üìò'}</div>
                    <div class="item-info">
                        <div class="item-title">${b.title}</div>
                        <div class="item-author">${b.author}</div>
                        <div class="item-meta">
                            <div style="display:flex; align-items:center; gap:4px;">
                                <div class="status-dot status-${b.status}"></div>
                                ${labels[b.status]}
                            </div>
                            <span>‚Ä¢ ${b.currentPage}/${b.totalPages} syf</span>
                        </div>
                    </div>
                    ${b.status === 'reading' ? 
                        `<button onclick="event.stopPropagation(); openProgressModal(${b.id})" style="background:var(--bg-elevated); border:1px solid var(--border-subtle); color:var(--accent-gold); width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center;">‚ö°Ô∏è</button>` 
                        : ''}
                </div>
                `;
            }).join('');
        }

        // --- ANALYTICS ENGINE (The Smart Part) ---
        function renderAnalytics() {
            const today = new Date().toISOString().split('T')[0];
            
            // Calculate Dates
            const now = new Date();
            // Start of Week (Monday)
            const dayOfWeek = now.getDay() || 7; 
            const monday = new Date(now);
            monday.setDate(now.getDate() - dayOfWeek + 1);
            const mondayStr = monday.toISOString().split('T')[0];
            
            // Start of Month
            const monthStr = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            // Start of Year
            const yearStr = new Date(now.getFullYear(), 0, 1).toISOString().split('T')[0];

            let dailySum = 0;
            let weeklySum = 0;
            let monthlySum = 0;
            let yearlyBooks = 0;

            // Loop all books and history
            books.forEach(b => {
                // Count completed books for year
                if (b.status === 'completed' && b.endDate && b.endDate >= yearStr) {
                    yearlyBooks++;
                }

                // Sum pages from history
                if (b.history) {
                    b.history.forEach(h => {
                        if (h.date === today) dailySum += h.pagesRead;
                        if (h.date >= mondayStr) weeklySum += h.pagesRead;
                        if (h.date >= monthStr) monthlySum += h.pagesRead;
                    });
                }
            });

            // Targets
            const dTarget = settings.dailyGoal;
            const wTarget = dTarget * 7;
            const mTarget = dTarget * 30;
            const yTarget = settings.yearlyGoal;

            // Render Rings & Text
            updateRing('dailyRing', dailySum, dTarget);
            updateRing('weeklyRing', weeklySum, wTarget);
            updateRing('monthlyRing', monthlySum, mTarget);
            updateRing('yearlyRing', yearlyBooks, yTarget);

            document.getElementById('dailyRead').innerText = dailySum;
            document.getElementById('dailyTarget').innerText = dTarget;
            document.getElementById('dailyPercent').innerText = `%${Math.min(100, Math.round(dailySum/dTarget*100))} Tamamlandƒ±`;

            document.getElementById('weeklyRead').innerText = weeklySum;
            document.getElementById('weeklyTarget').innerText = wTarget;
            document.getElementById('weeklyPercent').innerText = `%${Math.min(100, Math.round(weeklySum/wTarget*100))} Tamamlandƒ±`;

            document.getElementById('monthlyRead').innerText = monthlySum;
            document.getElementById('monthlyTarget').innerText = mTarget;
            document.getElementById('monthlyPercent').innerText = `%${Math.min(100, Math.round(monthlySum/mTarget*100))} Tamamlandƒ±`;

            document.getElementById('yearlyRead').innerText = yearlyBooks;
            document.getElementById('yearlyTarget').innerText = yTarget;
            document.getElementById('yearlyPercent').innerText = `%${Math.min(100, Math.round(yearlyBooks/yTarget*100))} Tamamlandƒ±`;

            // Stats
            document.getElementById('statTotalBooks').innerText = books.filter(b => b.status === 'completed').length;
            
            // Simple Streak Logic (Checks if read yesterday or today)
            // Advanced streak needs more logic, keep it simple for now
            let streak = dailySum > 0 ? 1 : 0; // Placeholder
            document.getElementById('statStreak').innerText = streak;
        }

        function updateRing(id, current, max) {
            const circle = document.getElementById(id);
            const radius = circle.r.baseVal.value;
            const circumference = radius * 2 * Math.PI;
            
            const percent = Math.min(100, (current / max) * 100);
            const offset = circumference - (percent / 100) * circumference;
            
            circle.style.strokeDashoffset = offset;
        }

        // --- INTERACTIONS ---

        // Filters
        document.getElementById('filterBtn').addEventListener('click', () => {
            const modes = ['all', 'reading', 'completed', 'wishlist'];
            const idx = modes.indexOf(currentFilter);
            currentFilter = modes[(idx + 1) % modes.length];
            renderList();
        });

        // Tabs
        window.switchTab = function(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            if(tab === 'library') {
                document.getElementById('view-library').classList.remove('hidden');
                document.getElementById('view-analytics').classList.add('hidden');
                renderHero(); // Refresh hero
            } else {
                document.getElementById('view-library').classList.add('hidden');
                document.getElementById('view-analytics').classList.remove('hidden');
                renderAnalytics(); // Refresh charts
            }
        }

        // Modals
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }
        window.closeModal = function(id) {
            document.getElementById(id).classList.remove('active');
        }

        // Add/Edit Book
        const fab = document.getElementById('fabBtn');
        fab.addEventListener('click', openAddModal);

        function openAddModal() {
            document.getElementById('bookForm').reset();
            document.getElementById('bookId').value = '';
            document.getElementById('modalTitle').innerText = 'Yeni Kitap Ekle';
            document.getElementById('btnDelete').classList.add('hidden');
            document.getElementById('mCurrent').value = 0;
            openModal('bookModal');
        }

        window.openEditModal = function(id) {
            const book = books.find(b => b.id === id);
            if (!book) return;
            
            document.getElementById('bookId').value = book.id;
            document.getElementById('mTitle').value = book.title;
            document.getElementById('mAuthor').value = book.author;
            document.getElementById('mPages').value = book.totalPages;
            document.getElementById('mCurrent').value = book.currentPage;
            document.getElementById('mStatus').value = book.status;
            
            document.getElementById('modalTitle').innerText = 'Kitabƒ± D√ºzenle';
            document.getElementById('btnDelete').classList.remove('hidden');
            openModal('bookModal');
        }

        // Save Book Logic
        document.getElementById('bookForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('bookId').value;
            const title = document.getElementById('mTitle').value;
            const author = document.getElementById('mAuthor').value;
            const total = parseInt(document.getElementById('mPages').value);
            const current = parseInt(document.getElementById('mCurrent').value);
            const status = document.getElementById('mStatus').value;

            if (id) {
                // Edit
                const book = books.find(b => b.id == id);
                book.title = title;
                book.author = author;
                book.totalPages = total;
                book.currentPage = current;
                book.status = status;
                if (status === 'completed' && !book.endDate) {
                    book.endDate = new Date().toISOString().split('T')[0];
                    book.currentPage = total;
                }
            } else {
                // New
                const newBook = {
                    id: Date.now(),
                    title, author, 
                    totalPages: total, 
                    currentPage: current, 
                    status,
                    history: [],
                    cover: null // Future: Allow URL
                };
                if (status === 'completed') {
                    newBook.endDate = new Date().toISOString().split('T')[0];
                    newBook.currentPage = total;
                }
                books.push(newBook);
                
                // Bug fix: If viewing a specific filter, reset or switch to ensure user sees the new book
                currentFilter = 'all'; 
            }
            saveData();
            closeModal('bookModal');
        });

        // Delete Book
        window.deleteBook = function() {
            if(confirm('Bu kitabƒ± silmek istediƒüine emin misin?')) {
                const id = document.getElementById('bookId').value;
                books = books.filter(b => b.id != id);
                saveData();
                closeModal('bookModal');
            }
        }

        // Progress Update
        window.openProgressModal = function(id) {
            const book = books.find(b => b.id === id);
            document.getElementById('progBookId').value = book.id;
            document.getElementById('progBookTitle').innerText = book.title;
            document.getElementById('progCurrentPage').value = book.currentPage;
            openModal('progressModal');
        }

        document.getElementById('progressForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = parseInt(document.getElementById('progBookId').value);
            const newPage = parseInt(document.getElementById('progCurrentPage').value);
            const book = books.find(b => b.id === id);

            if (book) {
                const diff = newPage - book.currentPage;
                
                // Log History if progress made
                if (diff > 0) {
                    const today = new Date().toISOString().split('T')[0];
                    // Check if entry for today exists
                    const todayEntry = book.history.find(h => h.date === today);
                    if (todayEntry) {
                        todayEntry.pagesRead += diff;
                    } else {
                        book.history.push({ date: today, pagesRead: diff });
                    }
                }

                book.currentPage = newPage;
                if (book.currentPage >= book.totalPages) {
                    book.status = 'completed';
                    book.endDate = new Date().toISOString().split('T')[0];
                    alert('Tebrikler! Kitabƒ± bitirdin. üéâ');
                }
                saveData();
                closeModal('progressModal');
            }
        });

        // Settings
        document.getElementById('settingsBtn').addEventListener('click', () => {
            document.getElementById('setDailyGoal').value = settings.dailyGoal;
            document.getElementById('setYearlyGoal').value = settings.yearlyGoal;
            openModal('settingsModal');
        });

        // Auto-save settings on input change
        document.getElementById('setDailyGoal').addEventListener('change', (e) => {
            settings.dailyGoal = parseInt(e.target.value);
            saveData();
        });
        document.getElementById('setYearlyGoal').addEventListener('change', (e) => {
            settings.yearlyGoal = parseInt(e.target.value);
            saveData();
        });

        // Export/Import
        window.exportData = function() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({books, settings}));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "kitaplik_yedek_" + new Date().toISOString().split('T')[0] + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        window.importData = function(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.books && data.settings) {
                        if(confirm('Mevcut verilerin √ºzerine yazƒ±lacak. Emin misin?')) {
                            books = data.books;
                            settings = data.settings;
                            saveData();
                            alert('Veriler ba≈üarƒ±yla y√ºklendi.');
                            closeModal('settingsModal');
                        }
                    } else {
                        alert('Ge√ßersiz dosya formatƒ±.');
                    }
                } catch(err) {
                    alert('Dosya okuma hatasƒ±.');
                }
            };
            reader.readAsText(file);
        }

        // Init
        renderAll();

    </script>
</body>
</html>
